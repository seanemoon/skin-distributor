{% extends "layout.html" %}
{% block body %}
  <div class=section>{{ event.name }}</div>
  <div class=container>
    <div class='event'>
      <div id="template">
        Email Template
        {% if template %}
        <div class="view-button" >View</div>
        <div class="edit-button">Edit</div>
        {% else %}
        <div class="create-button">Create</div>
        {% endif %}
      </div>
      <div id="recipients">
        Recipients
        {% if num_recipients %}
          <div class="clear-button">Clear</div>
          <div class="info">
            {{ num_recipients }} recipients.
          </div>
        {% else %}
        {% endif %}
      </div>
      <div id="codes">
        Codes
        {% if code_info %}
          <div class="clear-button">Clear</div>
          <div class="info">
            {% for code in code_info %}
              {{ code.name }}: {{ code.count }}
            {% endfor %}
          </div>
        {% else %}
        {% endif %}
      </div>
    </div>
  </div>
  <script type=text/javascript>
    $(document).ready(function() {


      function sendFiles(files, section) {

        var data = new FormData();
        $.each(files, function(key, value) {
          data.append(key, value)
        });

        $.ajax({
          type: 'post',
          url: "{{url_for('upload_file')}}",
          data: data,
          success: function() {
            console.log("hey!");
          },
          dataType: 'json',
          processData: false,
          contentType: false,
        });
      }

      function addDropZone(section) {
          var dropZone = $('<div/>', {
            class: 'drop_zone',
            text: 'Drop ' + section + ' file here.',
          });

          // Handle drop zone file drop
          function handleFileDrop(event) {
            event.stopPropagation();
            event.preventDefault();
            event.dataTransfer = event.originalEvent.dataTransfer;
            $(dropZone).removeClass('dragover');
            var files = event.dataTransfer.files;
            sendFiles(files, "lol")
            for (var i = 0; i < files.length; i++) {
              var f = files[i];
              console.log(f.name);
            }
          }

          // Handle drag over drop zone
          function handleDragOver(event) {
            event.stopPropagation();
            event.preventDefault();
            event.dataTransfer = event.originalEvent.dataTransfer;
            event.dataTransfer.dropEffect = 'copy';
            $(dropZone).addClass('dragover');
          }

          function handleDragLeave(event) {
            event.stopPropagation();
            event.preventDefault();
            $(dropZone).removeClass('dragover');
          }

          dropZone.bind('dragover', handleDragOver);
          dropZone.bind('dragleave', handleDragLeave);
          dropZone.bind('drop', handleFileDrop);
          dropZone.appendTo('#' + section);
      }
      {% if code_info %}
      {% else %}
        addDropZone('codes');
      {% endif %}

      {% if num_recipients %}
      {% else %}
        addDropZone('recipients');
      {% endif %}

      // RECIPIENTS BUTTONS
      $(function() {
        // Clear Recipients
        var processing = false;
        $('#recipients .clear-button').click(function() {
          if (!processing) {
            processing = true
            $.getJSON("{{url_for('clear_recipients')}}", {
              event_id: {{event.id}}
            }, function(data) {
              // Change the page
              if (data['success']) {
                addDropZone('recipients');
                $('#recipients .clear-button').remove();
                $('#recipients .info').remove();
              }
              processing = false;
            });
          }
        });
      });

      // CODES BUTTONS
      $(function() {
        // Clear Codes
        var processing = false;
        $('#codes .clear-button').click(function() {
          if (!processing) {
            processing = true;
            $.getJSON("{{url_for('clear_codes')}}", {
              event_id: {{event.id}}
            }, function(data) {
              if (data['success']) {
                addDropZone('codes');
                $('#codes .clear-button').remove();
                $('#codes .info').remove();
              }
              processing = false;
            });
          }
        });
      });

      // TEMPLATE BUTTONS
      $(function() {
        // Create Template
        $('#template .create-button').click(function() {
          var url = "{{ url_for('create_template', event_id=event.id) }}"
          $(location).attr('href', url)
        });

        // View Template
        $('#template .view-button').click(function() {
          var url = "{{ url_for('view_template', event_id=event.id) }}"
          $(location).attr('href', url)
        });

        // Edit Template
        $('#template .edit-button').click(function() {
          var url = "{{ url_for('edit_template', event_id=event.id) }}"
          $(location).attr('href', url)
        });
      });
    }); </script>
{% endblock %}
